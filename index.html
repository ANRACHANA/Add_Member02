<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telegram Add Member Ultimate</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:sans-serif;background:#0f172a;color:#fff;display:flex;justify-content:center;padding:30px 10px;}
.container{width:100%;max-width:750px;background:#1e293b;border-radius:20px;padding:30px;box-shadow:0 15px 40px rgba(0,0,0,0.5);}
h2{text-align:center;color:#38bdf8;margin-bottom:20px;}
h3{margin:20px 0 10px;color:#a5b4fc;}
input,textarea,select{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:none;background:#0f172a;color:#fff;}
textarea{height:120px;resize:vertical;}
.btns{display:flex;gap:15px;margin-top:20px;flex-wrap:wrap;}
button{flex:1;padding:12px;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:all 0.3s;}
.start{background:linear-gradient(90deg,#38bdf8,#0ea5e9);}
.stop{background:linear-gradient(90deg,#f87171,#ef4444);}
.restart{background:linear-gradient(90deg,#fbbf24,#f59e0b);}
.stats{display:flex;justify-content:space-around;background:#0f172a;padding:15px 10px;border-radius:12px;border:1px solid #334155;margin-top:15px;font-weight:600;}
#status{margin-top:20px;background:#0f172a;padding:12px;border-radius:12px;border:1px solid #334155;min-height:30px;line-height:1.4;}
#memberList{margin-top:15px;height:300px;overflow-y:auto;background:#020617;padding:10px;border-radius:10px;border:1px solid #334155;font-family:monospace;}
#memberList div{padding:2px 0;}
label input[type="checkbox"]{margin-right:8px;}
@media(max-width:600px){.btns{flex-direction:column;}}
.floodWait{color:#ef4444;font-weight:600;}

/* CMD colors */
.log-success{color:#22c55e;}
.log-fail{color:#ef4444;}
.log-skip{color:#fbbf24;}
.log-info{color:#38bdf8;}

/* Loading blinking */
.cmd-loading::after{
  content:"_";
  animation: blink 1s infinite;
}
@keyframes blink{
  0%,50%,100%{opacity:1;}
  25%,75%{opacity:0;}
}

/* Progress bar */
.progressBox{
  margin-top:10px;
  background:#020617;
  border:1px solid #334155;
  border-radius:10px;
  padding:10px;
}
.progressBar{
  width:100%;
  height:14px;
  background:#0f172a;
  border-radius:8px;
  overflow:hidden;
}
.progressFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22c55e,#38bdf8);
  transition:width 0.3s ease;
}
.progressText{
  margin-top:5px;
  font-size:12px;
  text-align:center;
  font-family:Consolas, monospace;
}

/* Modal styles */
#accountsModal{
  display:none;
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:1000;
}
#accountsModal .modalContent{
  background:#1e293b;
  padding:20px;
  border-radius:15px;
  width:90%; max-width:500px;
  max-height:80%;
  overflow-y:auto;
  position:relative;
}
#accountsModal .closeBtn{
  position:absolute;
  top:10px; right:10px;
  background:#ef4444;
  border:none;
  color:#fff;
  padding:5px 10px;
  border-radius:5px;
  cursor:pointer;
}
.accountsBox{max-height:300px;overflow-y:auto;background:#0f172a;padding:10px;border-radius:10px;border:1px solid #334155;}
.accountsBox div{padding:5px 0;}
</style>
</head>
<body>
<div class="container">
<h2>Telegram Add Member Ultimate</h2>

<button onclick="openAccountsModal()" style="padding:8px 12px; border-radius:8px; background:#38bdf8; color:#fff; border:none; cursor:pointer;">Show Accounts</button>

<!-- Modal -->
<div id="accountsModal">
  <div class="modalContent">
    <h3>Select Accounts</h3>
    <div id="accountsList" class="accountsBox"></div>
    <label><input type="checkbox" id="selectAllModal" onchange="toggleSelectAllModal()"> Select All</label>
    <button class="closeBtn" onclick="closeAccountsModal()">X</button>
  </div>
</div>

<input type="text" id="sourceGroup" placeholder="Source Group">
<div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
  <div>
    <label>Members:</label>
    <select id="filterMembers">
      <option value="all" selected>All</option>
      <option value="username">Username Only</option>
    </select>
  </div>
  <div>
    <label>Last Online:</label>
    <select id="filterLastOnline">
      <option value="all" selected>All</option>
      <option value="week">This Week</option>
      <option value="month">This Month</option>
    </select>
  </div>
  <div>
    <label>Profile Photo:</label>
    <select id="filterPhoto">
      <option value="all" selected>All</option>
      <option value="has">Has Photo</option>
    </select>
  </div>
</div>

<div style="margin-top:10px;font-weight:600;">
  Export Total: <span id="exportTotal">0</span>
</div>
<button class="start" onclick="exportMembers()">Export Members</button>

<input type="text" id="targetGroup" placeholder="Target Group">

<textarea id="users" placeholder="IDs/Usernames"></textarea>

<div class="btns">
<button class="start" onclick="start()">Start</button>
<button class="stop" onclick="stop()">Stop</button>
<button class="restart" onclick="restart()">Restart</button>
</div>

<div class="stats">
<div>Success: <span id="success">0</span></div>
<div>Fail: <span id="fail">0</span></div>
</div>

<div class="progressBox">
  <div class="progressBar">
    <div id="progressFill" class="progressFill"></div>
  </div>
  <div class="progressText">
    Progress: <span id="progressCount">0</span>/<span id="progressTotal">0</span> | ETA: <span id="eta">--:--</span>
  </div>
</div>

<div id="status"></div>
<div id="memberList"></div>
</div>

<script>
let isRunning=false, totalUsers=0, processedUsers=0, startTime=null;

/* Modal Functions */
function openAccountsModal(){ document.getElementById("accountsModal").style.display="flex"; }
function closeAccountsModal(){ document.getElementById("accountsModal").style.display="none"; }
function toggleSelectAllModal(){
  const checked=document.getElementById("selectAllModal").checked;
  document.querySelectorAll("#accountsList .accountChk:not(:disabled)").forEach(chk=>chk.checked=checked);
}

/* CMD Logger */
function cmdLog(text,type="info"){
  const box=document.getElementById("memberList");
  const div=document.createElement("div");
  div.className=`log-${type}`;
  div.innerText=text;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

/* Load Accounts with Flood Wait status */
async function loadAccounts(){
  const res = await fetch("/accounts");
  const accounts = await res.json();
  const floodRes = await fetch("/flood-waits");
  const floodData = await floodRes.json();
  const container=document.getElementById("accountsList");
  container.innerHTML="";

  accounts.forEach(acc=>{
    const fw=floodData.find(f=>f.account===acc.name && new Date(f.endTime)>new Date());
    const isBlocked=!!fw;
    const labelText=isBlocked
      ? `${acc.name} (${acc.phone}) â€“ Wait until ${fw.endTime}`
      : `${acc.name} (${acc.phone})`;

    const div=document.createElement("div");
    div.innerHTML=`<label>
      <input type="checkbox" class="accountChk" value="${acc.name}" ${isBlocked?'disabled':''}>
      ${labelText}
    </label>`;
    container.appendChild(div);
  });
}
loadAccounts();

function getSelectedAccounts(){
  const selected=[];
  document.querySelectorAll(".accountChk:checked").forEach(chk=>selected.push(chk.value));
  return selected;
}

/* Export Members */
async function exportMembers(){
  const selectedAccounts=getSelectedAccounts();
  if(selectedAccounts.length===0){ alert("Select at least one account"); return; }
  const group=document.getElementById("sourceGroup").value;
  const account=selectedAccounts[0];
  const filterMembers=document.getElementById("filterMembers").value;
  const filterLastOnline=document.getElementById("filterLastOnline").value;
  const filterPhoto=document.getElementById("filterPhoto").value;

  document.getElementById("status").innerText="Loading members...";
  const res=await fetch("/export-members",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({account, group, filterMembers, filterLastOnline, filterPhoto})
  });
  const data=await res.json();
  if(data.success){
    document.getElementById("users").value=data.ids.join("\n");
    document.getElementById("exportTotal").innerText=data.ids.length;
    document.getElementById("status").innerText=`Exported ${data.ids.length} members`;
  } else {
    document.getElementById("status").innerText=`Error: ${data.error}`;
  }
}

/* Restart Function */
async function restart(){
  await fetch("/restart",{method:"POST"});
  document.getElementById("memberList").innerHTML="";
  document.getElementById("progressFill").style.width="0%";
  document.getElementById("progressCount").innerText=0;
  document.getElementById("eta").innerText="--:--";
  document.getElementById("success").innerText=0;
  document.getElementById("fail").innerText=0;
  document.getElementById("users").value="";
  document.getElementById("exportTotal").innerText=0;

  cmdLog("> RESTARTED","info");

  // Reload accounts in modal
  await loadAccounts();
  openAccountsModal();
}

/* Start / Stop functions placeholder */
async function start(){ cmdLog("> START clicked","info"); }
async function stop(){ cmdLog("> STOP clicked","info"); }
</script>
</body>
</html>